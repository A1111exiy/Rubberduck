using Rubberduck.Inspections.Abstract;
using System;
using System.Collections.Generic;
using System.Linq;
using Rubberduck.Parsing;
using Rubberduck.VBEditor;
using Rubberduck.Inspections.Resources;
using Rubberduck.Parsing.Grammar;
using Rubberduck.Parsing.Symbols;
using System.Windows.Forms;
using Rubberduck.UI.Refactorings;
using Rubberduck.Common;
using System.Text.RegularExpressions;

namespace Rubberduck.Inspections.QuickFixes
{
    public class AssignedByValParameterQuickFix : QuickFixBase
    {
        private readonly Declaration _target;
        private string _localCopyVariableName;
        private bool _forceUseOfSuggestedName;
        private readonly string[] _originalCodeLines;

        public AssignedByValParameterQuickFix(Declaration target, QualifiedSelection selection)
            : base(target.Context, selection, InspectionsUI.AssignedByValParameterQuickFix)
        {
            _target = target;
            _forceUseOfSuggestedName = false;
            _localCopyVariableName = string.Empty;

            _originalCodeLines = GetMethodLines();
        }

        public override bool CanFixInModule { get { return false; } }
        public override bool CanFixInProject { get { return false; } }

        //This function exists solely to support unit testing - by preventing the popup dialog 
        public void TESTONLY_FixUsingAutoGeneratedName()
        {
            _forceUseOfSuggestedName = true;
            Fix();
        }

        public override void Fix()
        {
            if (_forceUseOfSuggestedName)
            {
                _localCopyVariableName = AutoSuggestedName();
                IsCancelled = false;
            }
            else
            {
                GetLocalCopyVariableNameFromUser();
            }

            if (!IsCancelled)
            {
                ModifyBlockToUseLocalCopyVariable();
            }
        }

        private void GetLocalCopyVariableNameFromUser()
        {
            using (var view = new AssignedByValParameterQuickFixDialog(_originalCodeLines))
            {
                view.Target = _target;
                view.NewName = AutoSuggestedName();
                view.ShowDialog();

                IsCancelled = view.DialogResult == DialogResult.Cancel;
                if (!IsCancelled) { _localCopyVariableName = view.NewName; }
            }
        }

        private void ModifyBlockToUseLocalCopyVariable()
        {
            if (ProposedNameIsInUse()) { return; }

            var module = Selection.QualifiedName.Component.CodeModule;
            var context = _target.Context;

            var references = _target.References;
            IdentifierReference idRefx = references.FirstOrDefault();
            var firstLine = idRefx.Selection.StartLine;
            var moduleLines = GetModuleLines();
            foreach ( IdentifierReference idRef in references)
            {
                var lineNumber = idRef.Selection.StartLine;
                var newStatement = ReplaceByValReference(moduleLines[lineNumber - 1]);
                module.ReplaceLine(lineNumber, newStatement);
            }
            var startLine = Selection.Selection.StartLine;

            module.InsertLines(++startLine, BuildLocalCopyDeclaration());
            module.InsertLines(++startLine, BuildLocalCopyAssignment());
        }

        private string ReplaceByValReference(string input)
        {
            int startOfReferenceIndex = 0;
            for (int idx = 0; startOfReferenceIndex >=0 && idx < input.Length; idx++)
            {
                startOfReferenceIndex = input.IndexOf(_target.IdentifierName, idx);
                if (startOfReferenceIndex >= 0)
                {
                    var preceedingChar = input.Substring(startOfReferenceIndex == 0 ? 0 : startOfReferenceIndex - 1, 1);
                    if(!char.IsLetter(preceedingChar, 0))
                    {
                        var endOfReferenceIndex = startOfReferenceIndex + _target.IdentifierName.Length - 1;
                        if(endOfReferenceIndex >= input.Length - 1)
                        {
                            input = input.Replace(preceedingChar + _target.IdentifierName, preceedingChar + _localCopyVariableName);
                        }
                        else
                        {
                            var followingChar = endOfReferenceIndex >= input.Length - 1 ? string.Empty : input.Substring(endOfReferenceIndex + 1, 1);
                            if (!char.IsLetter(followingChar, 0))
                            {
                                input = input.Replace(preceedingChar + _target.IdentifierName + followingChar, preceedingChar + _localCopyVariableName + followingChar);
                            }
                        }
                    }
                    idx = startOfReferenceIndex + _target.IdentifierName.Length;
                }
                else
                {
                    idx = input.Length;
                }
            }

            return input;
        }
        private void ModifyBlockToUseLocalCopyVariable(int i)
        {
            if (ProposedNameIsInUse()) { return; }

            var module = Selection.QualifiedName.Component.CodeModule;
            var startLine = Selection.Selection.StartLine;

            module.InsertLines(++startLine, BuildLocalCopyDeclaration());
            module.InsertLines(++startLine, BuildLocalCopyAssignment());
            var moduleLines = GetModuleLines();
            //moduleLines array index is zero-based 
            var endOfScopeStatement = GetEndOfScopeStatementForDeclaration(moduleLines[Selection.Selection.StartLine - 1]);

            var isInScope = true;
            int zbIndex; //Zero-Based index for moduleLines array
            //starts with lines after the above inserts
            for (zbIndex = startLine ; isInScope && zbIndex < module.CountOfLines; zbIndex++)
            {
                var obIndex = zbIndex + 1; //One-Based index for module object
                if (LineRequiresUpdate(moduleLines[zbIndex]))
                {
                    var newStatement = moduleLines[zbIndex].Replace(_target.IdentifierName, _localCopyVariableName);
                    module.ReplaceLine(obIndex, newStatement);
                }
                isInScope = !moduleLines[zbIndex].Contains(endOfScopeStatement);
            }
        }

        private bool ProposedNameIsInUse()
        {
            return GetMethodLines().Any(c => c.Contains(Tokens.Dim + " " + _localCopyVariableName + " "));
        }

        private bool LineRequiresUpdate(string line)
        {
            return line.Contains(" " + _target.IdentifierName + " ")
                                    || line.Contains(NameAsLeftHandSide())
                                    || line.Contains(NameAsRightHandSide())
                                    || line.Contains(NameAsObjectMethodOrAccessorCall())
                                    || line.Contains(NameAsSubOrFunctionParam())
                                    || line.Contains(NameAsSubOrFunctionParamFirst())
                                    || line.Contains(NameAsSubOrFunctionParamLast());
        }

        private string NameAsLeftHandSide() { return _target.IdentifierName + " "; }
        private string NameAsRightHandSide() { return " " + _target.IdentifierName; }
        private string NameAsObjectMethodOrAccessorCall() { return " " + _target.IdentifierName + "."; }
        private string NameAsSubOrFunctionParam() { return _target.IdentifierName + ","; }
        private string NameAsSubOrFunctionParamFirst() { return "(" + _target.IdentifierName; }
        private string NameAsSubOrFunctionParamLast() { return _target.IdentifierName + ")"; }

        private string BuildLocalCopyDeclaration()
        {
            return Tokens.Dim + " " + _localCopyVariableName + " " + Tokens.As 
                + " " + _target.AsTypeName;
        }

        private string BuildLocalCopyAssignment()
        {
            return (SymbolList.ValueTypes.Contains(_target.AsTypeName) ? string.Empty : Tokens.Set + " ") 
                + _localCopyVariableName + " = " + _target.IdentifierName;
        }

        private string[] GetModuleLines()
        {
            var module = Selection.QualifiedName.Component.CodeModule;
            var lines = module.GetLines(1, module.CountOfLines);
            string[] newLine = { "\r\n" };
            return lines.Split(newLine, StringSplitOptions.None);
        }

        private string[] GetMethodLines()
        {
            var zbIndex = Selection.Selection.StartLine - 1;
            var allLines = GetModuleLines();

            var endStatement = GetEndOfScopeStatementForDeclaration(allLines[zbIndex]);

            var isInScope = true;
            var codeBlockLines = new List<string>();
            for ( ; isInScope && zbIndex < allLines.Count(); zbIndex++)
            {
                codeBlockLines.Add(allLines[zbIndex]);
                isInScope = !allLines[zbIndex].Contains(endStatement);
            }
            return codeBlockLines.ToArray();
        }

        private string GetEndOfScopeStatementForDeclaration(string declaration)
        {
            return declaration.Contains("Sub ") ? "End Sub" : "End Function";
        }

        private string AutoSuggestedName()
        {
            return "local" + _target.IdentifierName.CapitalizeFirstLetter();
        }
    }
}
